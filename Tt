Tu as cette erreur parce que data.message.keyword nâ€™existe pas dans ton mapping (pas de sous-champ keyword). Du coup doc['data.message.keyword'] est introuvable.
La solution est de lire le texte depuis _source puis dâ€™Ã©mettre la valeur avec emit().

âœ… Script runtime qui marche sans .keyword

Type du runtime field : Long (ou Number)

Set value : ON

Script :


// Lire le message depuis _source (plusieurs structures possibles)
String msg = null;

if (params._source != null) {
  def src = params._source;

  // Cas 1: objet imbriquÃ© { "data": { "message": "..." } }
  if (src.containsKey('data') && src.data != null && src.data instanceof Map && src.data.containsKey('message')) {
    msg = src.data.message;
  }

  // Cas 2: champ aplati "data.message" (flattened)
  if (msg == null && src.containsKey('data.message')) {
    msg = src['data.message'];
  }

  // Cas 3: message au premier niveau (au cas oÃ¹)
  if (msg == null && src.containsKey('message')) {
    msg = src.message;
  }
}

// Extraire "PMs lues : <nombre>" et l'Ã©mettre
if (msg != null) {
  def m = /PMs lues\s*:\s*([0-9]+)/.matcher(msg);
  if (m.find()) {
    emit(Long.parseLong(m.group(1)));
  }
}

> Pour les autres mÃ©triques, ne change que la regex :

PMs concernÃ©es\s*:\s*([0-9]+)

PMs non concernÃ©es\s*:\s*([0-9]+)

PMs en anomalies\s*:\s*([0-9]+)




ğŸ§ª Astuce debug (si Ã§a Ã©choue encore)

1. CrÃ©e temporairement un runtime field Type = keyword nommÃ© debug_msg avec :



String msg = null;
if (params._source != null) {
  def src = params._source;
  if (src.containsKey('data') && src.data instanceof Map && src.data.containsKey('message')) msg = src.data.message;
  else if (src.containsKey('data.message')) msg = src['data.message'];
  else if (src.containsKey('message')) msg = src.message;
}
if (msg != null) emit(msg);

2. Va dans Discover et ajoute debug_msg pour voir exactement le contenu rÃ©el.


3. Ajuste ensuite la regex si nÃ©cessaire.



âš ï¸ Ã€ Ã©viter

doc['data.message'] sur un champ text â†’ fielddata disabled.

doc['data.message.keyword'] si le sous-champ nâ€™existe pas â†’ No field found.

return au lieu de emit() â†’ cast [int] to [void].


Une fois pms_lues OK, crÃ©e pms_concernees, pms_non_concernees, pms_anomalies, puis fais une viz Metric avec Max() (ou â€œLast valueâ€) pour chaque tuile du dashboard.

