// Lecture du message, quelle que soit la structure du document
def msg = null;

if (params._source != null) {
  // Cas 1 : structure imbriquée { "data": { "message": "..." } }
  if (params._source.containsKey('data') && params._source.data instanceof Map && params._source.data.containsKey('message')) {
    msg = params._source.data.message;
  }
  // Cas 2 : champ aplati "data.message"
  else if (params._source.containsKey('data.message')) {
    msg = params._source['data.message'];
  }
}

// Extraction de la valeur numérique après "PMs lues :"
if (msg != null) {
  def m = /PMs lues\s*:\s*([0-9]+)/.matcher(msg);
  if (m.find()) {
    emit(Long.parseLong(m.group(1)));
  }
}